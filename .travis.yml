language: python
python:
  - "2.7.14"

matrix:
  include:

    # Job 1: Linters
    - env: python2-linters
      sudo: false
      language: python
      python: "2.7.14"
      script:
        - pip install -r requirements/prod.txt --no-deps --require-hashes
        - pip check
        - pip install -r requirements/dev.txt --no-deps
        - pip install -r requirements/mozautomation.txt --no-deps
        - pip check
        - flake8 --show-source

    # Job 2: Unit Tests in Docker env
    - env: docker-wptsync-test
      # Upgrade to newer docker version
      addons:
        apt:
          packages:
            - docker-ce
      sudo: required
      services:
        - docker
      before_install:
        - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
        - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
        - sudo apt-get update
        - sudo apt-cache madison docker-ce
        - sudo apt-get -y --alow-downgrades -o Dpkg::Options::="--force-confnew" install docker-ce=17.12.1~ce-0~ubuntu
      install:
        - docker --version
        - docker build -t wptsync_dev --file docker/Dockerfile.dev .
        - sudo chown -R 10001 .
      script:
        - ./bin/run_docker_dev.sh test --no-flake8

    # Job 3: Static Analysis
    - env: static-analysis
      sudo: false
      language: python
      python: "2.7.14"
      script:
        - pip install bandit
        - bandit -r sync -ll

notifications:
  irc:
    channels:
      - "irc.mozilla.org#wpt-sync"
    on_success: change
    on_failure: always
